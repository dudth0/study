# 배너 베리에이션 Design Document

> **Summary**: 글자수 제한에 맞춰 홍보카피를 자동으로 요약/변환하는 AI 기반 시스템 설계
>
> **Project**: core
> **Version**: 0.0.1-SNAPSHOT
> **Author**: Developer
> **Date**: 2026-02-08
> **Status**: Draft
> **Planning Doc**: [배너-베리에이션.plan.md](../01-plan/features/배너-베리에이션.plan.md)

### Pipeline References (if applicable)

| Phase | Document | Status |
|-------|----------|--------|
| Phase 1 | [Schema Definition](../01-plan/schema.md) | N/A |
| Phase 2 | [Coding Conventions](../01-plan/conventions.md) | N/A |
| Phase 3 | [Mockup](../02-design/mockup/배너-베리에이션.md) | N/A |
| Phase 4 | [API Spec](../02-design/api/배너-베리에이션.md) | N/A |

---

## 1. Overview

### 1.1 Design Goals

- AI 기반 텍스트 요약 기능을 통한 자동화된 카피 생성
- 다양한 글자수 제한에 대응 가능한 유연한 시스템
- 캐싱을 통한 API 호출 최소화 및 비용 절감
- Fallback 메커니즘으로 안정적인 서비스 제공

### 1.2 Design Principles

- **Single Responsibility**: 각 레이어는 명확한 책임을 가짐
- **Dependency Inversion**: 인터페이스를 통한 느슨한 결합
- **Fail-Safe Design**: AI API 실패 시에도 서비스 지속 가능
- **Performance First**: 캐싱과 비동기 처리로 응답 속도 최적화

---

## 2. Architecture

### 2.1 Component Diagram

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   Client        │────▶│   Spring Boot    │────▶│   Database      │
│   (REST API)    │     │   Application    │     │   (H2/MySQL)    │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                               │
                               ▼
                        ┌──────────────────┐
                        │   OpenAI API     │
                        │   (External)     │
                        └──────────────────┘
```

### 2.2 Layer Architecture (Clean Architecture)

```
┌──────────────────────────────────────────────────────────────┐
│                     Presentation Layer                        │
│  CopyController (REST API Endpoints)                         │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                     Application Layer                         │
│  CopyService, SummarizerService (Business Logic)             │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                       Domain Layer                            │
│  Copy, CopyVariation (Domain Entities)                       │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                        │
│  CopyRepository, OpenAIClient, Cache                         │
└──────────────────────────────────────────────────────────────┘
```

### 2.3 Data Flow

```
User Request
    │
    ▼
CopyController (Validation)
    │
    ▼
CopyService (Business Logic)
    │
    ├──▶ Cache Check (Caffeine)
    │    └──▶ Cache Hit → Return Cached Result
    │
    └──▶ Cache Miss
         │
         ▼
    SummarizerService
         │
         ├──▶ OpenAIClient (Primary)
         │    └──▶ Success → Cache & Return
         │
         └──▶ FallbackSummarizer (on failure)
              └──▶ Simple Algorithm → Return
```

### 2.4 Dependencies

| Component | Depends On | Purpose |
|-----------|-----------|---------|
| CopyController | CopyService | API 요청 처리 |
| CopyService | SummarizerService, CopyRepository | 비즈니스 로직 |
| SummarizerService | OpenAIClient, FallbackSummarizer | AI 요약 처리 |
| OpenAIClient | OpenAI REST API | 외부 AI 서비스 연동 |
| CopyRepository | JPA | 데이터 영속성 |

---

## 3. Data Model

### 3.1 Entity Definition

#### Copy (원본 카피)

```java
@Entity
@Table(name = "copies")
public class Copy {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, columnDefinition = "TEXT")
    private String originalText;

    @Column(nullable = false)
    private String title;

    @Column(nullable = false)
    private String category;  // 카테고리 (예: 프로모션, 이벤트)

    @OneToMany(mappedBy = "copy", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<CopyVariation> variations = new ArrayList<>();

    @Column(nullable = false)
    private LocalDateTime createdAt;

    @Column(nullable = false)
    private LocalDateTime updatedAt;

    @Column
    private String createdBy;  // 작성자 (향후 인증 연동)

    // getters, setters, constructors
}
```

#### CopyVariation (베리에이션)

```java
@Entity
@Table(name = "copy_variations")
public class CopyVariation {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "copy_id", nullable = false)
    private Copy copy;

    @Column(nullable = false)
    private Integer characterLimit;  // 글자수 제한 (10, 20, 50, 100)

    @Column(nullable = false, columnDefinition = "TEXT")
    private String summarizedText;

    @Column(nullable = false)
    @Enumerated(EnumType.STRING)
    private VariationStatus status;  // AUTO_GENERATED, MANUALLY_EDITED

    @Column(nullable = false)
    private Boolean isManuallyEdited;

    @Column(nullable = false)
    private LocalDateTime createdAt;

    @Column
    private LocalDateTime editedAt;

    // getters, setters, constructors
}
```

#### VariationStatus (Enum)

```java
public enum VariationStatus {
    AUTO_GENERATED,      // AI로 자동 생성됨
    MANUALLY_EDITED,     // 사용자가 수동 편집함
    FAILED              // 생성 실패 (Fallback 사용)
}
```

### 3.2 Entity Relationships

```
[Copy] 1 ──── N [CopyVariation]
  │
  │ 속성:
  │  - id (PK)
  │  - originalText
  │  - title
  │  - category
  │  - createdAt
  │  - updatedAt
  │
  └──▶ [CopyVariation]
        │ 속성:
        │  - id (PK)
        │  - copy_id (FK)
        │  - characterLimit
        │  - summarizedText
        │  - status
        │  - isManuallyEdited
        │  - createdAt
```

### 3.3 Database Schema

```sql
-- Copy 테이블
CREATE TABLE copies (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    original_text TEXT NOT NULL,
    title VARCHAR(255) NOT NULL,
    category VARCHAR(100) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    INDEX idx_category (category),
    INDEX idx_created_at (created_at)
);

-- CopyVariation 테이블
CREATE TABLE copy_variations (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    copy_id BIGINT NOT NULL,
    character_limit INT NOT NULL,
    summarized_text TEXT NOT NULL,
    status VARCHAR(50) NOT NULL,
    is_manually_edited BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    edited_at TIMESTAMP NULL,
    FOREIGN KEY (copy_id) REFERENCES copies(id) ON DELETE CASCADE,
    INDEX idx_copy_id (copy_id),
    INDEX idx_character_limit (character_limit)
);
```

---

## 4. API Specification

### 4.1 Endpoint List

| Method | Path | Description | Auth |
|--------|------|-------------|------|
| POST | /api/copies | 원본 카피 생성 및 자동 베리에이션 생성 | Optional |
| GET | /api/copies | 카피 목록 조회 | Optional |
| GET | /api/copies/{id} | 특정 카피 및 베리에이션 조회 | Optional |
| PUT | /api/copies/{id} | 원본 카피 수정 | Optional |
| DELETE | /api/copies/{id} | 카피 삭제 | Optional |
| PUT | /api/copies/{id}/variations/{variationId} | 베리에이션 수동 편집 | Optional |
| POST | /api/copies/{id}/regenerate | 베리에이션 재생성 | Optional |

### 4.2 Detailed Specification

#### `POST /api/copies`

원본 카피를 저장하고 지정된 글자수 제한에 맞는 베리에이션을 자동 생성합니다.

**Request:**
```json
{
  "originalText": "봄맞이 특별 할인! 모든 상품 최대 50% 할인 이벤트가 진행됩니다. 지금 바로 방문하셔서 놀라운 혜택을 받아보세요!",
  "title": "봄 할인 프로모션",
  "category": "프로모션",
  "characterLimits": [10, 20, 50, 100]
}
```

**Response (201 Created):**
```json
{
  "id": 1,
  "originalText": "봄맞이 특별 할인! 모든 상품 최대 50% 할인 이벤트가 진행됩니다...",
  "title": "봄 할인 프로모션",
  "category": "프로모션",
  "variations": [
    {
      "id": 1,
      "characterLimit": 10,
      "summarizedText": "봄 할인 50%",
      "status": "AUTO_GENERATED",
      "isManuallyEdited": false,
      "createdAt": "2026-02-08T14:30:00Z"
    },
    {
      "id": 2,
      "characterLimit": 20,
      "summarizedText": "봄 특가! 전품목 최대 50% 할인",
      "status": "AUTO_GENERATED",
      "isManuallyEdited": false,
      "createdAt": "2026-02-08T14:30:00Z"
    },
    {
      "id": 3,
      "characterLimit": 50,
      "summarizedText": "봄맞이 특별 할인 이벤트! 모든 상품 최대 50% 할인. 지금 바로 확인하세요!",
      "status": "AUTO_GENERATED",
      "isManuallyEdited": false,
      "createdAt": "2026-02-08T14:30:00Z"
    }
  ],
  "createdAt": "2026-02-08T14:30:00Z",
  "updatedAt": "2026-02-08T14:30:00Z"
}
```

**Error Responses:**
- `400 Bad Request`: 입력 유효성 검증 실패
  ```json
  {
    "error": "INVALID_INPUT",
    "message": "originalText는 필수 항목입니다.",
    "timestamp": "2026-02-08T14:30:00Z"
  }
  ```
- `503 Service Unavailable`: AI API 호출 실패 (Fallback 사용)
  ```json
  {
    "error": "AI_API_UNAVAILABLE",
    "message": "AI 서비스 일시적 장애, Fallback 알고리즘 사용됨",
    "timestamp": "2026-02-08T14:30:00Z"
  }
  ```

#### `GET /api/copies/{id}`

**Response (200 OK):**
```json
{
  "id": 1,
  "originalText": "봄맞이 특별 할인! ...",
  "title": "봄 할인 프로모션",
  "category": "프로모션",
  "variations": [...],
  "createdAt": "2026-02-08T14:30:00Z",
  "updatedAt": "2026-02-08T14:30:00Z"
}
```

**Error Responses:**
- `404 Not Found`: 카피를 찾을 수 없음

#### `PUT /api/copies/{id}/variations/{variationId}`

베리에이션을 수동으로 편집합니다.

**Request:**
```json
{
  "summarizedText": "봄 대할인 50% OFF"
}
```

**Response (200 OK):**
```json
{
  "id": 1,
  "characterLimit": 10,
  "summarizedText": "봄 대할인 50% OFF",
  "status": "MANUALLY_EDITED",
  "isManuallyEdited": true,
  "createdAt": "2026-02-08T14:30:00Z",
  "editedAt": "2026-02-08T15:00:00Z"
}
```

#### `POST /api/copies/{id}/regenerate`

특정 글자수 제한의 베리에이션을 재생성합니다.

**Request:**
```json
{
  "characterLimits": [10, 20]
}
```

**Response (200 OK):**
```json
{
  "regeneratedCount": 2,
  "variations": [...]
}
```

---

## 5. Service Layer Design

### 5.1 CopyService

```java
@Service
@RequiredArgsConstructor
public class CopyService {
    private final CopyRepository copyRepository;
    private final SummarizerService summarizerService;

    @Transactional
    public CopyResponseDto createCopy(CopyCreateRequestDto request) {
        // 1. Copy 엔티티 생성
        Copy copy = Copy.builder()
            .originalText(request.getOriginalText())
            .title(request.getTitle())
            .category(request.getCategory())
            .build();

        // 2. 각 글자수 제한에 대해 베리에이션 생성
        for (Integer limit : request.getCharacterLimits()) {
            String summarized = summarizerService.summarize(
                request.getOriginalText(),
                limit
            );

            CopyVariation variation = CopyVariation.builder()
                .copy(copy)
                .characterLimit(limit)
                .summarizedText(summarized)
                .status(VariationStatus.AUTO_GENERATED)
                .build();

            copy.addVariation(variation);
        }

        // 3. 저장
        Copy savedCopy = copyRepository.save(copy);

        return CopyResponseDto.from(savedCopy);
    }

    // 기타 메서드들...
}
```

### 5.2 SummarizerService

```java
@Service
@RequiredArgsConstructor
public class SummarizerService {
    private final OpenAIClient openAIClient;
    private final FallbackSummarizer fallbackSummarizer;
    private final CacheManager cacheManager;

    @Value("${ai.summarizer.timeout:3000}")
    private int timeout;

    public String summarize(String originalText, int characterLimit) {
        // 1. 캐시 확인
        String cacheKey = generateCacheKey(originalText, characterLimit);
        String cached = cacheManager.getCache("summaries").get(cacheKey, String.class);
        if (cached != null) {
            return cached;
        }

        // 2. OpenAI API 호출
        try {
            String result = openAIClient.summarize(originalText, characterLimit);
            cacheManager.getCache("summaries").put(cacheKey, result);
            return result;
        } catch (Exception e) {
            log.warn("OpenAI API failed, using fallback: {}", e.getMessage());
            // 3. Fallback 알고리즘 사용
            return fallbackSummarizer.summarize(originalText, characterLimit);
        }
    }

    private String generateCacheKey(String text, int limit) {
        return DigestUtils.md5Hex(text) + ":" + limit;
    }
}
```

### 5.3 OpenAIClient

```java
@Component
@RequiredArgsConstructor
public class OpenAIClient {
    @Value("${openai.api.key}")
    private String apiKey;

    @Value("${openai.model:gpt-4}")
    private String model;

    private final RestTemplate restTemplate;

    public String summarize(String text, int characterLimit) {
        String prompt = String.format(
            "다음 텍스트를 정확히 %d자 이내로 요약해주세요. 핵심 내용을 유지하되, 자연스러운 문장으로 작성해주세요:\n\n%s",
            characterLimit,
            text
        );

        OpenAIRequest request = OpenAIRequest.builder()
            .model(model)
            .messages(List.of(
                new Message("system", "당신은 마케팅 카피를 요약하는 전문가입니다."),
                new Message("user", prompt)
            ))
            .maxTokens(100)
            .temperature(0.7)
            .build();

        OpenAIResponse response = restTemplate.postForObject(
            "https://api.openai.com/v1/chat/completions",
            request,
            OpenAIResponse.class
        );

        return response.getChoices().get(0).getMessage().getContent().trim();
    }
}
```

### 5.4 FallbackSummarizer

```java
@Component
public class FallbackSummarizer {
    public String summarize(String text, int characterLimit) {
        // 간단한 Fallback 알고리즘
        // 1. 문장 단위로 분리
        String[] sentences = text.split("[.!?]");

        // 2. 글자수 제한에 맞게 문장 선택
        StringBuilder result = new StringBuilder();
        for (String sentence : sentences) {
            String trimmed = sentence.trim();
            if (result.length() + trimmed.length() <= characterLimit) {
                result.append(trimmed);
            } else {
                break;
            }
        }

        // 3. 빈 결과 방지
        if (result.length() == 0 && text.length() > characterLimit) {
            result.append(text.substring(0, characterLimit - 3)).append("...");
        }

        return result.toString();
    }
}
```

---

## 6. Error Handling

### 6.1 Error Code Definition

| Code | Message | Cause | Handling |
|------|---------|-------|----------|
| INVALID_INPUT | 입력 데이터가 유효하지 않습니다 | 유효성 검증 실패 | 400 Bad Request |
| COPY_NOT_FOUND | 카피를 찾을 수 없습니다 | 존재하지 않는 ID | 404 Not Found |
| VARIATION_NOT_FOUND | 베리에이션을 찾을 수 없습니다 | 존재하지 않는 ID | 404 Not Found |
| AI_API_UNAVAILABLE | AI 서비스를 사용할 수 없습니다 | OpenAI API 장애 | 503 Service Unavailable (Fallback 사용) |
| INTERNAL_ERROR | 내부 서버 오류 | 예상치 못한 오류 | 500 Internal Server Error |

### 6.2 Global Exception Handler

```java
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(
        MethodArgumentNotValidException ex) {

        return ResponseEntity.badRequest().body(
            ErrorResponse.builder()
                .error("INVALID_INPUT")
                .message(ex.getBindingResult().getAllErrors().get(0).getDefaultMessage())
                .timestamp(LocalDateTime.now())
                .build()
        );
    }

    @ExceptionHandler(CopyNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleCopyNotFound(
        CopyNotFoundException ex) {

        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
            ErrorResponse.builder()
                .error("COPY_NOT_FOUND")
                .message(ex.getMessage())
                .timestamp(LocalDateTime.now())
                .build()
        );
    }

    @ExceptionHandler(OpenAIApiException.class)
    public ResponseEntity<ErrorResponse> handleOpenAIException(
        OpenAIApiException ex) {

        return ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE).body(
            ErrorResponse.builder()
                .error("AI_API_UNAVAILABLE")
                .message("AI 서비스 일시적 장애, Fallback 알고리즘 사용됨")
                .timestamp(LocalDateTime.now())
                .build()
        );
    }
}
```

---

## 7. Security Considerations

- [ ] **Input validation**:
  - originalText 최대 길이 제한 (5000자)
  - characterLimit는 양수이며 1000자 이하로 제한
  - XSS 방지를 위한 HTML 태그 제거

- [ ] **API Key 보안**:
  - OpenAI API 키는 환경 변수로 관리
  - 코드에 하드코딩 금지

- [ ] **Rate Limiting**:
  - IP별 요청 제한 (분당 100회)
  - API 남용 방지

- [ ] **Authentication** (향후 확장):
  - Spring Security를 통한 인증
  - 사용자별 카피 관리

---

## 8. Test Plan

### 8.1 Test Scope

| Type | Target | Tool |
|------|--------|------|
| Unit Test | Service, Repository | JUnit 5, Mockito |
| Integration Test | API endpoints | Spring Boot Test, MockMvc |
| External API Test | OpenAI Client | WireMock (Mock Server) |

### 8.2 Test Cases (Key)

#### Unit Tests

- [ ] **CopyService.createCopy()**: 정상적으로 카피 및 베리에이션 생성
- [ ] **SummarizerService.summarize()**: 캐시 히트 시 캐시에서 반환
- [ ] **SummarizerService.summarize()**: OpenAI 실패 시 Fallback 사용
- [ ] **FallbackSummarizer**: 글자수 제한에 맞게 요약

#### Integration Tests

- [ ] **POST /api/copies**: 201 Created, 베리에이션 포함
- [ ] **GET /api/copies/{id}**: 200 OK, 카피 및 베리에이션 반환
- [ ] **PUT /api/copies/{id}/variations/{variationId}**: 수동 편집 성공
- [ ] **POST /api/copies/{id}/regenerate**: 베리에이션 재생성 성공

#### Edge Cases

- [ ] 빈 문자열 입력 → 400 Bad Request
- [ ] 존재하지 않는 ID 조회 → 404 Not Found
- [ ] OpenAI API 타임아웃 → Fallback 사용, 503 반환

---

## 9. Clean Architecture

### 9.1 Layer Structure

| Layer | Responsibility | Location |
|-------|---------------|----------|
| **Presentation** | REST API, Request/Response DTO | `src/main/java/hello/core/presentation/copy/` |
| **Application** | Business logic, Service orchestration | `src/main/java/hello/core/application/copy/` |
| **Domain** | Entities, Value Objects, Business rules | `src/main/java/hello/core/domain/copy/` |
| **Infrastructure** | Database, External API, Cache | `src/main/java/hello/core/infrastructure/copy/` |

### 9.2 Dependency Rules

```
┌─────────────────────────────────────────────────────────────┐
│                    Dependency Direction                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Presentation ──→ Application ──→ Domain ←── Infrastructure│
│   (Controller)     (Service)       (Entity)   (Repository)  │
│                          │                                  │
│                          └──→ Infrastructure                │
│                               (OpenAIClient)                │
│                                                             │
│   Rule: Domain은 외부 의존성 없음 (Pure Java)                │
│         Infrastructure는 Domain 인터페이스 구현              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.3 This Feature's Layer Assignment

| Component | Layer | Location |
|-----------|-------|----------|
| CopyController | Presentation | `src/main/java/hello/core/presentation/copy/CopyController.java` |
| CopyService | Application | `src/main/java/hello/core/application/copy/CopyService.java` |
| SummarizerService | Application | `src/main/java/hello/core/application/copy/SummarizerService.java` |
| Copy, CopyVariation | Domain | `src/main/java/hello/core/domain/copy/` |
| CopyRepository | Infrastructure | `src/main/java/hello/core/infrastructure/copy/CopyRepository.java` |
| OpenAIClient | Infrastructure | `src/main/java/hello/core/infrastructure/copy/ai/OpenAIClient.java` |
| FallbackSummarizer | Infrastructure | `src/main/java/hello/core/infrastructure/copy/ai/FallbackSummarizer.java` |

---

## 10. Coding Convention Reference

### 10.1 Naming Conventions

| Target | Rule | Example |
|--------|------|---------|
| Classes | PascalCase | `CopyService`, `CopyController` |
| Methods | camelCase | `createCopy()`, `summarize()` |
| Constants | UPPER_SNAKE_CASE | `MAX_CHARACTER_LIMIT`, `API_TIMEOUT` |
| Variables | camelCase | `originalText`, `characterLimit` |
| Packages | lowercase | `hello.core.domain.copy` |

### 10.2 Package Structure

```
src/main/java/hello/core/
├── presentation/copy/
│   ├── CopyController.java
│   └── dto/
│       ├── CopyCreateRequestDto.java
│       ├── CopyResponseDto.java
│       └── VariationResponseDto.java
├── application/copy/
│   ├── CopyService.java
│   └── SummarizerService.java
├── domain/copy/
│   ├── Copy.java
│   ├── CopyVariation.java
│   └── VariationStatus.java
└── infrastructure/copy/
    ├── CopyRepository.java
    └── ai/
        ├── OpenAIClient.java
        ├── FallbackSummarizer.java
        └── dto/
            ├── OpenAIRequest.java
            └── OpenAIResponse.java
```

### 10.3 Environment Variables

```properties
# application.properties
spring.datasource.url=${SPRING_DATASOURCE_URL:jdbc:h2:mem:testdb}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME:sa}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD:}

# OpenAI API
openai.api.key=${OPENAI_API_KEY}
openai.model=${OPENAI_MODEL:gpt-4}
ai.summarizer.timeout=${AI_SUMMARIZER_TIMEOUT:3000}

# Cache
spring.cache.type=caffeine
spring.cache.caffeine.spec=maximumSize=1000,expireAfterWrite=3600s
```

---

## 11. Implementation Guide

### 11.1 File Structure

```
src/main/java/hello/core/
├── presentation/copy/
│   ├── CopyController.java
│   └── dto/
├── application/copy/
│   ├── CopyService.java
│   └── SummarizerService.java
├── domain/copy/
│   ├── Copy.java
│   ├── CopyVariation.java
│   └── VariationStatus.java
├── infrastructure/copy/
│   ├── CopyRepository.java
│   └── ai/
│       ├── OpenAIClient.java
│       └── FallbackSummarizer.java
└── config/
    ├── CacheConfig.java
    └── RestTemplateConfig.java
```

### 11.2 Implementation Order

1. [ ] **Domain Layer**: Entity 정의 (Copy, CopyVariation)
2. [ ] **Infrastructure Layer**: Repository 구현
3. [ ] **Infrastructure Layer**: OpenAIClient, FallbackSummarizer 구현
4. [ ] **Application Layer**: SummarizerService 구현 (캐싱 포함)
5. [ ] **Application Layer**: CopyService 구현
6. [ ] **Presentation Layer**: DTO 정의
7. [ ] **Presentation Layer**: CopyController 구현
8. [ ] **Configuration**: Cache, RestTemplate 설정
9. [ ] **Test**: Unit test, Integration test 작성
10. [ ] **Exception Handling**: GlobalExceptionHandler 구현

### 11.3 Dependencies to Add

```gradle
// build.gradle
dependencies {
    // 기존 의존성
    implementation 'org.springframework.boot:spring-boot-starter'

    // 추가 필요 의존성
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-cache'
    implementation 'com.github.ben-manes.caffeine:caffeine:3.1.8'

    // H2 Database (개발용)
    runtimeOnly 'com.h2database:h2'

    // MySQL (프로덕션용)
    runtimeOnly 'com.mysql:mysql-connector-j'

    // Lombok (코드 간소화)
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'

    // 테스트
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'com.github.tomakehurst:wiremock-jre8:2.35.0'
}
```

---

## 12. Performance Optimization

### 12.1 Caching Strategy

- **Cache Key**: `MD5(originalText):characterLimit`
- **Cache Size**: 최대 1000개
- **TTL**: 1시간 (3600초)
- **Cache Provider**: Caffeine (인메모리)

### 12.2 Database Indexing

```sql
-- 자주 조회되는 컬럼에 인덱스 추가
CREATE INDEX idx_category ON copies(category);
CREATE INDEX idx_created_at ON copies(created_at);
CREATE INDEX idx_copy_id ON copy_variations(copy_id);
CREATE INDEX idx_character_limit ON copy_variations(character_limit);
```

### 12.3 API Response Time Target

- 캐시 히트: < 50ms
- OpenAI 호출 (캐시 미스): < 3초
- Fallback 사용: < 100ms

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-02-08 | Initial design document | Developer |
